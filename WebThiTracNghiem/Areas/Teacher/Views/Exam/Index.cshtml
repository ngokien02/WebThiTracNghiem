@using System.Security.Claims
@model IEnumerable<ChuDe>

<div class="page-header">
	<h1>Tạo đề thi mới</h1>
</div>

<div class="form-section form-section--main" style="background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(25,118,210,0.08);padding:2.5rem 2rem;max-width:900px;margin:2rem auto;">
	<form class="exam-form" id="exam-form">
		<input type="hidden" id="IdGiangVien" value="@User.FindFirstValue(ClaimTypes.NameIdentifier)" />
		<h2>Thông tin cơ bản</h2>
		<div class="form-group">
			<label for="TieuDe">Tên đề thi:</label>
			<input type="text" id="TieuDe" name="TieuDe" placeholder="Nhập tên đề thi...">
			<span id="errTenDeThi" class="errMessage"></span>
		</div>
		<div class="form-group">
			<label for="ChuDe">Chủ đề:</label>
			<input list="chuDeOptions" id="ChuDe" name="ChuDe" class="form-control" placeholder="Nhập hoặc chọn chủ đề...">
			<datalist id="chuDeOptions">
				<option disabled>Nhập hoặc chọn chủ đề...</option>
				@foreach (var cd in Model)
				{
					<option value="@cd.TenCD"></option>
				}
			</datalist>
			<span id="errChuDe" class="errMessage"></span>
		</div>

		<div class="form-group">
			<label for="MaDe">Mã đề thi:</label>
			<input type="text" id="MaDe" name="MaDe" placeholder="Nhập mã đề thi...">
			<span id="errMaDeThi" class="errMessage"></span>
		</div>
		<div class="form-group">
			<label for="ThoiGian">Thời gian làm bài:</label>
			<input type="number" id="ThoiGian" name="ThoiGian" placeholder="Nhập thời gian (phút)" autocomplete="off">
			<span id="errTime" class="errMessage"></span>
		</div>

		<h2>Phương thức tạo đề thi</h2>
		<div class="form-group">
			<label><input type="radio" name="exam-create-method" value="upload" checked> Nhập file Word/PDF</label>
			<span id="errDeThiFile" class="text-danger small"></span>
			<label><input type="radio" name="exam-create-method" value="manual"> Tạo thủ công</label>
		</div>
		<div id="upload-section">
			<div class="form-group">
				<label for="exam-file">Chọn file đề thi (.doc, .docx):</label>
				<input type="file" id="exam-file" accept=".doc,.docx">
				<span id="errFile" class="errMessage"></span>
			</div>
		</div>
		<div id="manual-section" style="display:none;">
			<button id="question-bank-btn" type="button" class="btn primary btnQB" style="margin-bottom:10px;">Thêm từ ngân hàng câu hỏi</button>
			<div id="questions-list"></div>
			<button type="button" class="btn secondary" id="add-question-btn">+ Thêm câu hỏi</button>
		</div>

		<h2>Thời gian thi</h2>
		<div class="form-row">
			<div class="form-group">
				<label for="start-date">Ngày bắt đầu:</label>
				<input type="text" id="start-date" placeholder="dd/mm/yyyy" autocomplete="off">
				<span id="errStartDate" class="errMessage"></span>
			</div>
			<div class="form-group">
				<label for="start-time">Giờ bắt đầu:</label>
				<input type="time" id="start-time" lang="vi">
				<span id="errStartTime" class="errMessage"></span>
			</div>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label for="end-date">Ngày kết thúc:</label>
				<input type="text" id="end-date" placeholder="dd/mm/yyyy" autocomplete="off">
				<span id="errEndDate" class="errMessage"></span>
			</div>
			<div class="form-group">
				<label for="end-time">Giờ kết thúc:</label>
				<input type="time" id="end-time" lang="vi">
				<span id="errEndTime" class="errMessage"></span>
			</div>
		</div>

		<h2>Tùy chọn nâng cao:</h2>
		<div class="form-group">
			<div class="form-group">
				<label for="DiemToiDa">Số điểm tối đa:</label>
				<input type="number" id="DiemToiDa" name="DiemToiDa" placeholder="Nhập số điểm tối đa">
				<span id="errMaxScore" class="errMessage"></span>
			</div>
			<div class="checkbox-group">
				<label>
					<input type="checkbox" id="RandomCauHoi" name="RandomCauHoi">
					Xáo trộn thứ tự câu hỏi
				</label>
				<label>
					<input type="checkbox" id="RandomDapAn" name="RandomDapAn">
					Xáo trộn thứ tự đáp án
				</label>
				<label>
					<input type="checkbox" id="ShowKQ" name="ShowKQ">
					Hiển thị kết quả ngay sau khi nộp bài
				</label>
			</div>
		</div>

		<div class="form-actions">
			<button type="submit" class="btn primary btnTaoDeThi">Tạo đề thi</button>
			<button class="btn btn-danger btnHuyDeThi">Huỷ bỏ</button>
		</div>
	</form>
</div>

<div id="question-modal">
	<div class="modal-content">
		<h3><span style="color:#1976D2;"><i class="fas fa-list-alt"></i></span> Danh sách câu hỏi & đáp án</h3>
		<div id="modal-question-list">
			<!-- Questions will be dynamically added here -->
		</div>
		<div class="modal-actions">
			<button id="modal-accept-btn" class="btn primary">Chấp nhận</button>
			<button id="modal-cancel-btn" class="btn secondary">Hủy</button>
		</div>
	</div>
</div>
<div id="confirm-modal">
	<div class="modal-content">
		<h3>Xác nhận tạo đề thi?</h3>
		<div class="modal-info" id="modal-exam-info">
			<!-- Thông tin đề thi sẽ được render ở đây -->
		</div>
		<div class="modal-actions">
			<button class="btn primary" id="modal-confirm-btn">Xác nhận</button>
			<button class="btn btn-danger" id="modal-cancel-btn">Hủy</button>
		</div>
	</div>
</div>
<div id="loading-overlay">
	<div class="loading-box">
		<div class="spinner"></div>
		<div style="font-size:1.1rem;color:#1976D2;font-weight:500;">Đang phân tích file...</div>
	</div>
</div>

<!-- Modal (ẩn mặc định) -->
<div class="qb-modal" id="qb-modal">
	<div class="qb-overlay" data-action="close"></div>
	<div class="qb-content" role="dialog" aria-modal="true" aria-label="Ngân hàng câu hỏi">
		<div class="qb-body">
			<div class="qb-grid" id="qb-grid">
				<!-- Các câu hỏi ở đây -->
				<div class="qb-modal is-open">
					<div class="qb-overlay" data-action="close"></div>
					<div class="qb-content" role="dialog" aria-modal="true" aria-label="Ngân hàng câu hỏi">

						<!-- Header -->
						<div class="qb-header">
							<div class="qb-title">Ngân hàng câu hỏi</div>
							<button class="qb-close" data-action="close">×</button>
						</div>

						<!-- Toolbar -->
						<div class="qb-toolbar">
							<select class="qb-select" id="qb-topic">
								<option value="0">Tất cả chủ đề</option>
								@foreach (var cd in Model)
								{
									<option value="@cd.Id">@cd.TenCD</option>
								}
							</select>
							<input type="text" class="qb-search" id="qb-search" placeholder="Tìm kiếm câu hỏi...">
						</div>

						<!-- Body -->
						<div class="qb-body">
							<div class="qb-grid listQuestionFromBank" id="qb-grid">

								<!-- Item 1 -->
								@foreach (var cd in Model)
								{
									if (cd.CauHoiList != null && cd.CauHoiList.Any())
									{
										string[] ABCD = ["A", "B", "C", "D"];
										int i = 0;
										@foreach (var ch in cd.CauHoiList)
										{
											<div class="qb-item">
												<input type="checkbox">
												<div>
													<div class="qb-question">
														@ch.NoiDung
													</div>
													<div class="qb-answers">
														@foreach (var da in ch.DapAnList)
														{
															<div class="@(da.DungSai ? "dapAnDung" : "")">@ABCD[i]. @da.NoiDung</div>
															<b>@(da.DungSai ? "(Đúng)" : "")</b>
															i++;
														}
													</div>
												</div>
											</div>
											i = 0;
										}
									}
									else
									{
										<h1>Chưa có câu hỏi thuộc chủ đề này</h1>
									}
								}
							</div>
						</div>

						<!-- Footer -->
						<div class="qb-footer">
							<div class="qb-count" id="qb-count">Đã chọn: 0</div>
							<div class="qb-actions">
								<button class="btnQBModal" data-action="close">Hủy</button>
								<button class="btnQBModal btn-primary" id="qb-confirm">Thêm vào đề</button>
							</div>
						</div>

					</div>
				</div>

			</div>
		</div>

		<div class="qb-footer">
			<div class="qb-count" id="qb-count">Đã chọn: 0</div>
			<div class="qb-actions">
				<button class="btn" data-action="close">Hủy</button>
				<button class="btn btn-primary" id="qb-confirm">Thêm vào đề</button>
			</div>
		</div>
	</div>
</div>