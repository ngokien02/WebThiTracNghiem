@model List<KetQua>

<main class="main-content">
    <!-- Page Header -->
    <div class="page-header">
        <h1>Kết quả thi</h1>
        <div class="header-actions">
            <button class="btn-export btn-exportResults">
                <i class="fas fa-file-lines"></i>
                Xuất báo cáo
            </button>
        </div>
    </div>
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-info">
                    <h3>Tổng số sinh viên</h3>
                    <p class="stat-number">@Model.Select(k => k.IdSinhVien).Distinct().Count()</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-info">
                    <h3>Đã hoàn thành</h3>
                    <p class="stat-number">@Model.Count()</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
                <div class="stat-info">
                    <h3>Tỷ lệ đạt</h3>
                    <p class="stat-number">
                        @{
                            var total = Model.Count;
                            var pass = Model.Count(k => k.Diem >= 5);
                            var percent = total > 0 ? pass * 100 / total : 0;
                        }
                        @percent%
                    </p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                <div class="stat-info">
                    <h3>Điểm trung bình</h3>
                @{
                    var diemList = Model.Where(k => k.Diem.HasValue).Select(k => k.Diem.Value).ToList();
                    var diemTB = diemList.Any() ? diemList.Average() : 0.0;
                }
                <p class="stat-number">@diemTB.ToString("0.00")</p>
                </div>
            </div>
        </div>
        <!-- Filters -->
        <!-- Results Table -->
        <div class="results-section">
            <div class="results-header">
                <h2>Danh sách kết quả</h2>
                <div class="results-actions">
                    <div class="dropdown-filter">
                        <button class="btn-filter" onclick="toggleFilterDropdown()">
                            <i class="fas fa-sliders-h"></i> Lọc
                        </button>
                        <div class="filter-dropdown-content" id="filterDropdown">
                            <label for="fromDate">Từ ngày:</label>
                            <input type="date" id="fromDate" value="@ViewBag.FromDate" />

                            <label for="toDate">Đến ngày:</label>
                            <input type="date" id="toDate" value="@ViewBag.ToDate" />

                            <label for="examSelect">Kỳ thi:</label>
                            <select id="examSelect">
                                <option value="">Tất cả</option>
                                @foreach (var e in ViewBag.Exams)
                                {
                                    <option value="@e">@e</option>
                                }
                            </select>
                            <button class="btn-apply">Áp dụng</button>
                        </div>
                    </div>

                    <div class="search-box">
                        <input type="text" placeholder="Tìm kiếm sinh viên..." />
                        <button id="btnRelsutlSearch"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </div>
            <div class="results-table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>MSSV</th>
                            <th>Họ và tên</th>
                            <th>Đề Thi</th>
                            <th>Ngày thi</th>
                            <th>Thời gian làm bài</th>
                            <th>Điểm số</th>
                            <th>Kết quả</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            var duration = item.GioNop.HasValue
                            ? (item.GioNop.Value - item.GioLam).ToString(@"hh\:mm\:ss")
                            : "N/A";

                            <tr>
                                <td>@item.SinhVien?.UserName</td>
                                <td>@item.SinhVien?.HoTen</td>
                                <td>@item.DeThi?.TieuDe</td>
                                <td>@item.GioLam.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@duration</td>
                                <td>@item.Diem?.ToString("0.00")</td>
                                <td>
                                    <span class="status-badge @(item.Diem >= 5 ? "passed" : "failed")">
                                        @(item.Diem >= 5 ? "Đạt" : "Không đạt")
                                    </span>
                                </td>
                                <td>
                                    <button class="btn-view" title="Xem chi tiết" onclick="document.getElementById('resultModal_@item.Id').classList.add('is-open')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                <button class="btn-deleteResult" title="Xóa kết quả" data-id="@item.Id">
                                    <i class="fas fa-trash-can"></i>
                                </button>
                                </td>
                            </tr>
                            <!-- Modal riêng cho từng kết quả -->
                            <div class="result-modal" id="resultModal_@item.Id">
                                <div class="result-modal__overlay" data-action="close" onclick="this.closest('.result-modal').classList.remove('is-open')"></div>
                                <div class="result-modal__content" role="dialog" aria-modal="true" aria-label="Chi tiết kết quả bài thi">
                                    <div class="result-modal__header">
                                        <div class="result-modal__title">Chi tiết kết quả bài thi</div>
                                        <button class="result-modal__close" title="Đóng" data-action="close" onclick="this.closest('.result-modal').classList.remove('is-open')">×</button>
                                    </div>
                                    <div class="result-modal__body">
                                        <div class="result-summary" id="result-summary-@item.Id">
                                            <p><strong>Đề thi:</strong> @item.DeThi?.TieuDe</p>
                                            <p><strong>Sinh viên:</strong> @item.SinhVien?.HoTen (@item.SinhVien?.UserName)</p>
                                            <p><strong>Lớp:</strong> @item.SinhVien?.LopHoc</p>
                                            <p><strong>Ngày thi:</strong> @item.GioLam.ToString("dd/MM/yyyy HH:mm")</p>
                                            <p><strong>Thời gian làm bài:</strong> @duration</p>
                                            <p><strong>Điểm:</strong> @item.Diem</p>
                                            <p><strong>Kết quả:</strong> @(item.Diem >= 5 ? "Đạt" : "Không đạt")</p>
                                            <p><strong>Số câu đúng:</strong> @item.SoCauDung</p>
                                        </div>
                                        <div class="result-section">
                                            <h4>Chi tiết câu hỏi</h4>
                                            <div class="question-list" id="question-list-@item.Id">
                                                @foreach (var ct in item.ChiTietKQs)
                                                {
                                                    var ABCD = new[] { "A", "B", "C", "D", "E", "F" };
                                                    var i = 0;

                                                    <div class="question-card">
                                                        <p><strong>Câu hỏi:</strong> @ct.CauHoi?.NoiDung</p>
                                                        <ul>
                                                            @foreach (var da in ct.CauHoi.DapAnList)
                                                            {
                                                                var isSelected = ct.DapAnChons.Any(dc => dc.DapAnId == da.Id);
                                                                var isCorrect = da.DungSai; // 1 = đúng

                                                                var classes = "";
                                                                if (isCorrect) classes += "badge-correct";
                                                                if (isSelected) classes += " badge-selected";

                                                                <li>
                                                                    @ABCD[i]. @da.NoiDung
                                                                    <span class="@classes">
                                                                        @(isCorrect ? "(Đúng)" : "(Sai)")
                                                                        @(isSelected ? " (Sinh Viên Chọn)" : "")
                                                                    </span>
                                                                </li>

                                                                i++;
                                                            }
                                                        </ul>
                                                        <hr />
                                                    </div>
                                                }

                                            </div>
                                        </div>
                                    </div>  
                                    <div class="result-modal__footer">
                                        <button class="btn" data-action="close" onclick="this.closest('.result-modal').classList.remove('is-open')">Đóng</button>
                                    </div>
                                </div>
                            </div>
                        }
                    </tbody>

                </table>
            </div>

            
            <!-- Pagination -->
            <div class="pagination">
                <button class="btn-page page-Relsutlt page-item" @(ViewBag.CurrentPage == 1 ? "disabled" : "") href="/teacher/home/Results?page=1">
                    <i class="fas fa-chevron-left"></i>
                </button>

                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    <button class="btn-page page-Relsutlt page-item @(ViewBag.CurrentPage == i ? "active" : "")" href="/teacher/home/Results?page=@i">@i</button>
                }
                <button class="btn-page page-Relsutlt page-item" @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "") href="/teacher/home/Results?page=@ViewBag.TotalPages">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    
</main>



